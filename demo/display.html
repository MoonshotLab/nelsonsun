<html>
    <head>
        <title>Hand Crank Power</title>
        <style>
            body {
                overflow: hidden;
                font-family: Helvetica, Arial, sans-serif;
            }

            .start {
                position: absolute;
                top: 200px;
                padding: 0 250px;
                text-align: center;
                font-size: 3.0em;
                color: hsl(0, 0%, 20%);
            }

            .start p:nth-child(2) {
                color: hsl(0, 0%, 50%);
                font-size: 0.7em;
            }

            .countdown {
                display: none;
                position: absolute;
                font-size: 18.0em;
                text-align: center;
                top: 150px;
                width: 100%;
                color: hsl(0, 70%, 30%);
                font-weight: bold;
                margin: 0 auto;
            }

            .cranking {
                display: none;
                background: url('logo.png') no-repeat 50px 30px;
                height: 100%;
            }

            .result {
                display: none;
                position: absolute;
                font-size: 18.0em;
                text-align: center;
                top: 150px;
                width: 100%;
                font-weight: bold;
                margin: 0 auto;
            }

            .timer {
                position: absolute;
                top: 30px;
                right: 50px;
                color: hsl(0, 30%, 70%);
                font-size: 4.0em;
                font-weight: bold;
                text-align: right;
                line-height: 115px;
            }

            .timer span:nth-child(1) {
                color: hsl(0, 30%, 40%);
                font-size: 1.3em;
            }

            .spinner {
                position: absolute;
                width: 100%;
                bottom: -600px;
            }

            .spinner .circle {
                position: relative;
                width: 1200px;
                height: 1200px;
                margin: 0 auto;
                -webkit-transform: rotate(0);
                -webkit-transition: -webkit-transform 500ms;
            }

            .spinner .circle .half-top {
                position: absolute;
                top: 0;
                left: 0;
                width: 1200px;
                height: 600px;
                background: hsl(0, 0%, 90%);
                -webkit-border-radius: 600px 600px 0 0;
            }

            .spinner .circle .half-bottom {
                position: absolute;
                top: 600px;
                left: 0;
                width: 1200px;
                height: 600px;
                background: hsl(120, 50%, 50%);
                -webkit-border-radius: 0 0 600px 600px;
                -webkit-transition: background 500ms;
            }

            .spinner .circle .center {
                position: absolute;
                top: 200px;
                left: 200px;
                width: 800px;
                height: 800px;
                background: hsl(0, 0%, 100%);
                -webkit-border-radius: 399px;
            }

            .spinner .value {
                position: absolute;
                bottom: 650px;
                left: 50%;
                width: 400px;
                margin-left: -200px;
                font-size: 15.0em;
                font-weight: bold;
                text-align: center;
            }

            .spinner .label {
                position: absolute;
                bottom: 625px;
                left: 50%;
                width: 400px;
                margin-left: -200px;
                font-size: 4.0em;
                font-weight: bold;
                text-align: center;
                color: hsl(0, 0%, 30%);
            }
        </style>
    </head>
    <body>

        <div class="countdown"></div>

        <div class="start">
            <p>Turn the crank for 15 seconds. The average power you generate will be compared to a solar panel.</p>
            <p>Press SPACE when ready.</p>
        </div>

        <div class="cranking">
            <div class="timer"><span>15</span>.<span>000</span></div>

            <div class="spinner">
                <div class="circle">
                    <div class="half-top"></div>
                    <div class="half-bottom"></div>
                    <div class="center"></div>
                </div>
                <div class="value"></div>
                <div class="label">watts</div>
            </div>
        </div>

        <div class="result"></div>

        <script src="jquery.min.js"></script>
        <script>
            /* The main Application controller
            /********************************/

            function Application() {
                // Initialize
                this.current_view = 'start';
                this.countdown = new Countdown();
                this.timer = new Timer();
                this.spinner = new Spinner(this);
                this.power_values = [];
                this.average_power = 0;

                // Bind keypresses
                var obj = this;
                $(document).keypress(function(e) {
                    switch (e.keyCode) {
                        case 13:
                        case 32:
                            obj.next_view();
                            break;
                    }
                });
            }

            Application.prototype.next_view = function() {
                // Advance through the application
                var obj = this;
                switch (obj.current_view) {
                    case 'start':
                        obj.current_view = 'countdown';
                        $('.start').hide();
                        $('.countdown').fadeIn();
                        obj.countdown.start();
                        setTimeout(function() {
                            $('.countdown').hide();
                            $('.cranking').fadeIn();
                            obj.current_view = 'cranking';
                            obj.timer.start();
                            obj.spinner.enable();
                        }, 4000);
                        setTimeout(function() {
                            obj.spinner.disable();
                        }, 19000);
                        setTimeout(function() {
                            $('.cranking').fadeOut();
                        }, 21000);
                        setTimeout(function() {
                            $('.result').fadeIn();
                            obj.current_view = 'result';
                            obj.average_power = parseInt(obj.power_values.reduce(function(a, b) { return a + b; }, 0) /  obj.power_values.length);
                            $('.result').html(obj.average_power);
                        }, 22000);
                        break;
                    case 'result':
                        $('.result').hide();
                        $('.start').fadeIn();
                        obj.current_view = 'start';
                        break;
                }
            }

            /* The starting countdown controller
            /**********************************/

            function Countdown() {
                // Initialize
                this.countdown_el = $('.countdown');
            }

            Countdown.prototype.start = function() {
                // Begin counting down
                var obj = this;
                obj.countdown_el.html('3');

                setTimeout(function() {
                    obj.countdown_el.hide();
                    obj.countdown_el.html('2');
                    obj.countdown_el.fadeIn();
                }, 1000);

                setTimeout(function() {
                    obj.countdown_el.hide();
                    obj.countdown_el.html('1');
                    obj.countdown_el.fadeIn();
                }, 2000);

                setTimeout(function() {
                    obj.countdown_el.hide();
                    obj.countdown_el.html('Go.');
                    obj.countdown_el.fadeIn();
                }, 3000);
            }

            /* The cranking Timer controller
            /******************************/

            function Timer() {
                // Initialize
                this.timer_el = $('.cranking .timer');
                this.start_time = 0;
                this.interval;
            }

            Timer.prototype.start = function() {
                // Begin counting down
                var obj = this;
                obj.start_time = new Date().getTime();

                $('span:nth-child(1)', obj.timer_el).html('15');
                $('span:nth-child(2)', obj.timer_el).html('000');

                obj.interval = setInterval(function() {
                    var diff = 15000-(new Date().getTime() - obj.start_time);
                    $('span:nth-child(1)', obj.timer_el).html(parseInt(diff/1000));
                    $('span:nth-child(2)', obj.timer_el).html(('000' + diff%1000).substr(-3));
                    if (diff <= 0) {
                        clearInterval(obj.interval);
                        $('span:nth-child(1)', obj.timer_el).html('0');
                        $('span:nth-child(2)', obj.timer_el).html('000');
                    }
                }, 70);
            }


            /* The Spinner display controller
            /*******************************/

            function Spinner(app) {
                // Initialize
                this.position = 0;
                this.hue = 120;
                this.active = false;
                this.app = app;
            }

            Spinner.prototype.enable = function() {
                // Enable the spinner
                this.active = true;
                this.app.power_values = [];
            }

            Spinner.prototype.disable = function() {
                // Enable the spinner
                this.active = false;
            }

            Spinner.prototype.set_position = function(position) {
                // Set the position of the spinner
                if (!this.active) return;
                this.position = position;
                this.app.power_values.push(this.position);
                this.hue = parseInt(120 - this.position * 120 / 180);

                // Transition the css
                $('.spinner .circle').css({
                    '-webkit-transform': 'rotate(' + this.position + 'deg)'
                });
                $('.spinner .half-bottom').css({
                    'background': 'hsl(' + this.hue + ', 100%, 50%)',
                });

                // Display the power value
                $('.spinner .value').html(parseInt(this.position));
            }


            app = new Application();
            setInterval(function() {
                app.spinner.set_position(Math.abs(Math.random()*40-15+app.spinner.position)%180);
            }, 300);
        </script>
    </body>
</html>
